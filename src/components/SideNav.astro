---
/**
 * SideNav — Navegación Lateral Adaptativa
 *
 * - En HOME: Navegación por secciones fijas (Hero, Sobre Nosotros, etc.)
 * - En PROYECTO: Auto-detecta secciones + link "← Inicio"
 * Fixed position, centrada verticalmente, scroll suave vía Lenis.
 */

// Detectar si estamos en una página de proyecto
const currentPath = Astro.url.pathname;
const isProjectPage = currentPath.startsWith("/proyecto/");

// Secciones fijas para el home
const homeSections = [
  { id: "hero", label: "Inicio" },
  { id: "sobre-nosotros", label: "Sobre Nosotros" },
  { id: "proyectos", label: "Proyectos" },
  { id: "areas", label: "Áreas" },
  { id: "filosofia", label: "Filosofía" },
  { id: "contacto", label: "Contacto" },
];

// Labels más amigables para secciones de proyecto
const projectSectionLabels: Record<string, string> = {
  hero: "Inicio",
  "ficha-tecnica": "Ficha Técnica",
  memoria: "Memoria",
  galeria: "Galería",
};
---

<nav class="side-nav" aria-label="Navegación de secciones">
  {
    !isProjectPage ? (
      /* Home: Mostrar secciones fijas */
      <ul class="nav-list">
        {homeSections.map((section) => (
          <li class="nav-item">
            <a
              href={`#${section.id}`}
              class="nav-link"
              data-section={section.id}
              aria-label={`Ir a ${section.label}`}
            >
              <span class="nav-dot" />
              <span class="nav-label font-mono">{section.label}</span>
            </a>
          </li>
        ))}
      </ul>
    ) : (
      /* Proyecto: Se poblará dinámicamente vía JavaScript */
      <ul class="nav-list" data-dynamic-nav="true">
        {/* Link especial "Inicio" siempre presente en proyectos */}
        <li class="nav-item">
          <a
            href="/"
            class="nav-link nav-link--home"
            aria-label="Volver al inicio"
          >
            <span class="nav-icon">←</span>
            <span class="nav-label font-mono">Inicio</span>
          </a>
        </li>
      </ul>
    )
  }
</nav>

<script>
  import Lenis from "@studio-freight/lenis";

  // Mapeo de IDs a labels más amigables
  const projectSectionLabels: Record<string, string> = {
    hero: "Inicio",
    "ficha-tecnica": "Ficha Técnica",
    memoria: "Memoria",
    galeria: "Galería",
  };

  // Función para generar label desde el ID
  function generateLabel(id: string): string {
    if (projectSectionLabels[id]) {
      return projectSectionLabels[id];
    }
    // Fallback: capitalizar y reemplazar guiones
    return id
      .split("-")
      .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
      .join(" ");
  }

  document.addEventListener("DOMContentLoaded", () => {
    const navList = document.querySelector(".nav-list");
    const isDynamicNav = navList?.getAttribute("data-dynamic-nav") === "true";

    // Si estamos en una página de proyecto, detectar secciones dinámicamente
    if (isDynamicNav && navList) {
      const sections = document.querySelectorAll("section[id]");

      sections.forEach((section) => {
        const id = section.id;
        const label = generateLabel(id);

        // Crear nav item
        const li = document.createElement("li");
        li.className = "nav-item";

        const a = document.createElement("a");
        a.href = `#${id}`;
        a.className = "nav-link";
        a.setAttribute("data-section", id);
        a.setAttribute("aria-label", `Ir a ${label}`);

        const dot = document.createElement("span");
        dot.className = "nav-dot";

        const labelSpan = document.createElement("span");
        labelSpan.className = "nav-label font-mono";
        labelSpan.textContent = label;

        a.appendChild(dot);
        a.appendChild(labelSpan);
        li.appendChild(a);
        navList.appendChild(li);
      });
    }

    // Smooth scroll con Lenis al hacer click en links
    const navLinks = document.querySelectorAll(".nav-link");

    navLinks.forEach((link) => {
      link.addEventListener("click", (e) => {
        const href = link.getAttribute("href");

        // Si es link externo (inicio), dejar comportamiento por defecto
        if (href === "/") return;

        e.preventDefault(); // Prevenir salto instantáneo

        const targetId = href;
        if (!targetId) return;

        const targetElement = document.querySelector(targetId);
        if (!targetElement) return;

        // Scroll suave usando Lenis (accedemos a la instancia global)
        const lenis = (window as any).lenis;
        if (lenis) {
          lenis.scrollTo(targetElement, {
            offset: 0,
            duration: 1.4,
            easing: (t: number) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
          });
        } else {
          // Fallback si Lenis no está disponible
          targetElement.scrollIntoView({ behavior: "smooth" });
        }
      });
    });

    // Active section tracking con Intersection Observer
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            // Remover active de todos
            document.querySelectorAll(".nav-link").forEach((link) => {
              link.classList.remove("active");
            });

            // Agregar active al link correspondiente
            const id = entry.target.id;
            const activeLink = document.querySelector(`[data-section="${id}"]`);
            if (activeLink) {
              activeLink.classList.add("active");
            }
          }
        });
      },
      {
        rootMargin: "-50% 0px -50% 0px", // Trigger cuando esté en el centro
        threshold: 0,
      },
    );

    // Observar todas las secciones
    document.querySelectorAll("section[id]").forEach((section) => {
      observer.observe(section);
    });
  });
</script>

<style>
  .side-nav {
    position: fixed;
    right: var(--spacing-lg);
    top: 50%;
    transform: translateY(-50%);
    z-index: 100;
    opacity: 0;
    animation: fade-in-side 800ms ease-out 1s forwards;
  }

  @keyframes fade-in-side {
    from {
      opacity: 0;
      transform: translateY(-50%) translateX(20px);
    }
    to {
      opacity: 1;
      transform: translateY(-50%) translateX(0);
    }
  }

  .nav-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
  }

  .nav-item {
    margin: 0;
  }

  .nav-link {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    text-decoration: none;
    color: var(--color-muted);
    transition: all var(--duration-base) var(--ease-smooth);
    padding: var(--spacing-xs);
    position: relative;
  }

  /* Dot indicator */
  .nav-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    border: 1px solid var(--color-border);
    background-color: transparent;
    transition: all var(--duration-base) var(--ease-smooth);
    flex-shrink: 0;
  }

  /* Icon para link "Inicio" en proyectos */
  .nav-icon {
    font-size: 0.875rem;
    line-height: 1;
    opacity: 0.7;
    transition: all var(--duration-base) var(--ease-smooth);
  }

  /* Label - oculto por defecto */
  .nav-label {
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    opacity: 0;
    transform: translateX(-8px);
    transition: all var(--duration-base) var(--ease-smooth);
    white-space: nowrap;
    pointer-events: none;
  }

  /* Hover states */
  .nav-link:hover .nav-dot {
    background-color: var(--color-accent);
    border-color: var(--color-accent);
    transform: scale(1.3);
  }

  .nav-link:hover .nav-icon {
    opacity: 1;
    transform: translateX(-2px);
  }

  .nav-link:hover .nav-label {
    opacity: 1;
    transform: translateX(0);
  }

  .nav-link:hover {
    color: var(--color-accent);
  }

  /* Active state */
  .nav-link.active .nav-dot {
    background-color: var(--color-accent);
    border-color: var(--color-accent);
    width: 12px;
    height: 12px;
  }

  .nav-link.active .nav-label {
    opacity: 1; /* Label visible para sección activa */
    transform: translateX(0);
  }

  .nav-link.active {
    color: var(--color-foreground);
  }

  /* Link "Inicio" especial - sin dot, con icono */
  .nav-link--home .nav-icon {
    opacity: 1;
  }

  .nav-link--home:hover .nav-icon {
    transform: translateX(-2px);
  }

  /* Sección Hero - Label blanco para contraste con fondo oscuro */
  .nav-link.active[data-section="hero"] {
    color: var(--color-stone-light);
  }

  .nav-link.active[data-section="hero"] .nav-label {
    color: var(--color-stone-light);
  }

  /* Responsive - Ocultar en mobile */
  @media (max-width: 1024px) {
    .side-nav {
      display: none;
    }
  }

  /* Ajuste para pantallas pequeñas desktop */
  @media (min-width: 1024px) and (max-width: 1280px) {
    .side-nav {
      right: var(--spacing-md);
    }

    .nav-list {
      gap: var(--spacing-sm);
    }
  }
</style>
